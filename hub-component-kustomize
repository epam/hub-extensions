#!/bin/sh -e
# Copyright (c) 2023 EPAM Systems, Inc.
#
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.

# shellcheck disable=SC2086

if test -z "$1"; then
  cat << EOF
Error: verb has not been specidfied: $(basename "$0") VERB

Currently supported verbs: deploy, undeploy
EOF
  exit 1;
fi

ident() {
  sed 's/^/  /'
}

apply_crd_file() {
    max_di=$(yq e 'di' "$1" | tail -1)
    for i in $(seq 0 "$max_di"); do
        crd=$(yq e "select(di == $i).metadata.name" "$1")
        if test -z "$crd" -o "$crd" = "null"; then
            continue
        fi
        if $kubectl get crd "$crd" > /dev/null; then
            echo "  $crd already exists"
        else
            $kubectl create -f "$1"
        fi
    done
}

OLD_NS="$(kubectl config view --minify --output 'jsonpath={..namespace}')"
TEMP_DIR=$(mktemp -d || exit 1)
mkdir -p "$TEMP_DIR"
ERR=""

finalize() {
  rv=$?
  if test -n "$1"; then
    rm -rf "$1"
  fi
  current_ns="$(kubectl config view --minify --output 'jsonpath={..namespace}')"
  if test -n "$2" -a "$2" != "$current_ns"; then
    echo "Setting previous namespace: $2"
    kubectl config set-context --current --namespace="$2"
  fi
  if test -n "$3"; then
    color err << END
  Error: $3
END
  fi
  exit $rv
}

trap 'finalize "$TEMP_DIR" "$OLD_NS" "$ERR"' EXIT

temp_file() {
  echo "$TEMP_DIR/$(head -c 32 < /dev/urandom | base64 | tr -dc '[:lower:]')"
}

if test -n "$DOMAIN_NAME"; then
    color w "Environment variable: DOMAIN_NAME has been deprecated"
    color w "Use HUB_DOMAIN_NAME instead"
    HUB_DOMAIN_NAME="$DOMAIN_NAME"
    export HUB_DOMAIN_NAME
fi

VERB="$1"
kubectl="kubectl"
yq="yq -M"
if test -n "$HUB_DOMAIN_NAME"; then
  kubectl="$kubectl --context=$HUB_DOMAIN_NAME"
fi
if test -n "$NAMESPACE"; then
  echo "Setting current namespace: $NAMESPACE"
  kubectl config set-context --current --namespace="$NAMESPACE"
fi

case "$VERB" in
  "deploy" )
    kubectl_cmd="$kubectl apply"
  ;;
  "undeploy" )
    kubectl_cmd="$kubectl delete --ignore-not-found=true"
  ;;
  * )
    echo "Error: unsupported verb: $VERB"
    exit 1
  ;;
esac

HUB_DOMAIN_NAME=${HUB_DOMAIN_NAME:?"Required variable HUB_DOMAIN_NAME has not been defined"}
HUB_KUSTOMIZE_TARBALL_DIR="${HUB_KUSTOMIZE_TARBALL_DIR:-kustomize}"
# NAMESPACE=${NAMESPACE:?"Required variable DOMAIN_NAME has not been defined"}

apply_k8s_resources_file() {
    max_di=$(yq e 'di' "$1" | tail -1)
    for i in $(seq 0 "$max_di"); do
        kind=$(yq e "select(di == $i).kind | select(.) | downcase" "$1")
        name=$(yq e "select(di == $i).metadata.name | select(.)" "$1")
        if test -z "$name" -o -z "$kind"; then
            continue
        fi
        echo "  Checking $kind/$name"
        if $kubectl get "$kind" "$name" > /dev/null; then
            echo "  $name already exists"
        else
            echo "  (not an error) creating..."
            yq e "select(di == $i)" "$1" | $kubectl create -f -
        fi
    done
}

if test "$VERB" = "deploy"; then
  if test -n "$NAMESPACE"; then
    if ! $kubectl get namespace "$NAMESPACE" > /dev/null;  then
      $kubectl create namespace "$NAMESPACE"
    fi
  fi
  if test -n "$CRD"; then
    for crd in $CRD; do
        if echo "$crd" | grep -e '^https\?://' >/dev/null 2>&1; then
            echo "* Downloading from $crd"
            temp=$(temp_file)
            files download "$crd" "$temp"
            apply_crd_file "$temp"
        elif test -f "$crd"; then
            echo "* Reading from: $crd"
            apply_crd_file "$crd"
        else
            color w "Warning: file not found ($CRD)"
        fi
    done
  fi
  if test -d "crds"; then
      for file in crds/*.yaml crds/*.yml; do
          if test ! -f "$file"; then continue; fi
          echo "* Reading CRD from: $file"
          apply_k8s_resources_file "$file"
      done
  fi
fi


if test -n "$HUB_KUSTOMIZE_TARBALL_URL"; then
  #shellcheck disable=SC2153
  HUB_KUSTOMIZE_TARBALL_SUBPATHS="$(echo "$HUB_KUSTOMIZE_TARBALL_SUBPATHS $HUB_KUSTOMIZE_TARBALL_SUBPATH" | xargs)"
  echo "* Downloading component base from: $HUB_KUSTOMIZE_TARBALL_URL"
  count="$(echo "$HUB_KUSTOMIZE_TARBALL_SUBPATHS" | tr ':' ' ' | wc -w | xargs)"
  target="$(files abspath $HUB_KUSTOMIZE_TARBALL_DIR)"
  if test "$count" = "0"; then
    files download-tar "$HUB_KUSTOMIZE_TARBALL_URL" "$target"
  # elif test "$count" = "1"; then
  #   files download-tar "$HUB_KUSTOMIZE_TARBALL_URL" "$(pwd)/$HUB_KUSTOMIZE_TARBALL_DIR" --tar-subpath "$HUB_KUSTOMIZE_TARBALL_SUBPATHS"
  else
    temp="$TEMP_DIR/content"
    mkdir -p "$temp"
    files download-tar "$HUB_KUSTOMIZE_TARBALL_URL" "$temp"
    # HUB_KUSTOMIZE_TARBALL_SUBPATHS is an array of paths divided by space (tarball_source_path:destination_path tarball_source_path:destination_path)
    for subpath in $HUB_KUSTOMIZE_TARBALL_SUBPATHS; do
      src=$(echo "$subpath" | cut -d: -f1)
      dest=$(echo "$subpath" | cut -d: -f2)
      if test -z "$dest" -o "$dest" = "$src"; then
        dest="$(basename "$src")"
      fi
      if test -f "$target/$dest"; then
        color warn "File $dest already exists"
      elif test -d "$temp/$src"; then
        echo "  Extracting directory: $src to $HUB_KUSTOMIZE_TARBALL_DIR/$dest"
        mkdir -p "$target/$dest"
        cp -r "$temp/$src/" "$target/$dest"
      elif test -f "$temp/$src"; then
        echo "  Extracting file: $src to $HUB_KUSTOMIZE_TARBALL_DIR/$dest"
        files copy "$temp/$src" "$target/$dest"
      else
        ERR="$ERR\n  - Not found: $src"
        continue
      fi
    done
  fi
fi

if test -n "$ERR"; then
  exit 1
fi

if test -n "$HUB_KUSTOMIZE_RESOURCES"; then
  echo "* Downloading component resources..."
  for res in $HUB_KUSTOMIZE_RESOURCES; do
    if echo "$res" | grep -e '^https\?://' >/dev/null 2>&1; then
      echo "  Downloading from: $res"
      files download "$res" "$(pwd)/$HUB_KUSTOMIZE_TARBALL_DIR/$(basename "$res")"
    elif test -f "$res"; then
      echo "  Copying from: $res"
      files copy "$res" "$(pwd)/$HUB_KUSTOMIZE_TARBALL_DIR/$(basename "$res")"
    else
      color w "  Warning: file not found ($res)"
    fi
  done
fi

if test -x "pre-$VERB"; then
  echo "Running pre-$VERB hook..."
  "./pre-$VERB"
fi

if which kustomize > /dev/null; then
  echo "* Using kustomize"
  kustomize_build_cmd="kustomize build ."
elif which kubectl > /dev/null; then
  echo "* Using kubectl (kustomize found)"
  kustomize_build_cmd="kubectl kustomize ."
else
  echo "Error: kustomize or kubectl has not been found!"
  exit 5
fi

WORKDIR="$(mktemp -d)"
trap 'rm -rf -- "$WORKDIR"' EXIT

echo "* Running kustomize build"
$kustomize_build_cmd > "$WORKDIR/resources.yaml"

if test -n "$(yq e '. | select(.kind == "Namespace")' "$WORKDIR/resources.yaml")"; then
  echo "* Removing shared resource Namespace from kustomize build"
  color g "  HINT: consider moving Namespace to pre-$VERB script"
  yq e '. | select(.kind == "Namespace")' "$WORKDIR/resources.yaml" > "$WORKDIR/namespaces.yaml"
  yq e '.metadata.name | "  - " + .' "$WORKDIR/namespaces.yaml" | color g
  yq e '. | select(.kind == "Namespace" | not)' -i "$WORKDIR/resources.yaml"
  if test "$VERB" = deploy; then
    echo "* Processing Namespaces before other kustomize resources:"
    apply_k8s_resources_file "$WORKDIR/namespaces.yaml"
  fi
fi

if test "$VERB" = deploy; then
  for name in $(yq e '.metadata.namespace | ""+select(.)' $WORKDIR/resources.yaml | uniq ); do
    printf '%s' "  Checking namespace $name... "
    if $kubectl get namespace "$name" > /dev/null; then
      echo "(already exists)"
    else
      echo "  (not an error) creating..."
      $kubectl create namespace "$name"
    fi
  done
fi

# Special case for CRD
if test -n "$(yq e '. | select(.kind == "CustomResourceDefinition")' "$WORKDIR/resources.yaml")"; then
  $yq e '. | select(.kind == "CustomResourceDefinition")' "$WORKDIR/resources.yaml" > "$WORKDIR/crds.yaml"
  if test "$VERB" = deploy; then
    echo "* Processing CRDs before other kustomize resources:"
    apply_k8s_resources_file "$WORKDIR/crds.yaml"
  fi

  echo "* Removing CustomResourceDefinition from kustomize build"
  yq e '. | select(.kind == "CustomResourceDefinition" | not)' -i "$WORKDIR/resources.yaml"
fi

echo "* Processing kustomize resources..."
$kubectl_cmd -f "$WORKDIR/resources.yaml"

if test -x post-$VERB; then
  echo "Running post-$VERB hook..."
  ./post-$VERB
fi
